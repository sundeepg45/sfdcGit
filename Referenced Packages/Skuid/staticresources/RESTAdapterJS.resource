/*! Skuid Rockaway 8.11.0 02-06-2016 */
!function(a){var b=a.$,c=a.utils,d=c.startsWith,e=c.endsWith,f=c.contains,g=c.isString,h=c.getObjectProperty,i=c.hasObjectProperty,j=window.encodeURIComponent,k=function(){return a.builder?a.builder.core:null},l=c.combineUrls,m=1,n=function(a){return a&&g(a)&&"__skuid_new__"===a.substring(0,13)},o=function(){return"__skuid_new__"+m++},p=function(){return"__skuid__"+m++},q=function(a){var c="";a.fields&&a.fields.length&&b.each(a.fields,function(){return this.nameField?(c=this,!1):void 0})},r=function(a,c){var d,e=c.methods;return e&&e.length&&b.each(e,function(b,c){return c.type===a?(d=c,!1):void 0}),d},s=function(a,b){var c=r(a,b);return c?c:{type:a,verb:b.verb,endpoint:b.endpoint}},t=function(a,b){return!!r(a,b)},u=function(a){if(a)try{a=JSON.parse(a)}catch(b){}return a},v=function(c,e,h){var i=b.Deferred(),k=function(c,e,h){h=h||{},e||(e={method:c.verb,dataType:c.dataType,url:c.serviceUrl,type:"query",scopes:c.scopes});var i,m=c.getService(),n=m.serviceUrl||"",o=e.url||"",p=h.dfd;return m.authenticate(c,e).done(function(){i=m.authentication;var q,r={},s=!1;!h.isSample&&c.conditions&&b.each(c.conditions,function(a,b){if(b.inactive===!1&&b.sourceParam){var d,e=c.getConditionValueResult(b),f=e.status;if(f){if("deactivate"===status)return!0;if("noquery"===status)return s=!0,p.reject("Could not perform this query because no value could be found for merge variable  '"+b.sourceParam+"'"),!1}else d=e.value,r[b.sourceParam]=d?j(d):d}}),s||(q=m.createHTTPRequest(b.extend({},e,{apiExtensions:r,url:l(n,o),method:e.method||"GET",contentType:e.dataType||"application/json",body:e.data})),c.query=c.debug=q.url,a.ajax[m.useApexProxy?"proxy":"direct"](q).done(function(a){var d,j,l,n=q.method,r=a.statusCode,s=a.body,t=!1;if(l=function(a){g(a)?d+=": "+a:a.message&&(d+=": "+a.message)},j=function(){if(d=a.status,s){if(g(s))try{s=JSON.parse(s),t=!0}catch(c){}if(t)s.error?l(s.error):s.message&&g(s.message)?d+=": "+s.message:s.errors&&s.errors instanceof Array&&s.errors.length&&l(s.errors[0]);else if(s&&f(s,"/html")){var e,h=s.indexOf("<body"),i=s.indexOf("</body>",h);e=b(h&&i?s.substring(h,i+7):s),d+=": "+b.trim(e.text()||"")}else d+=": "+s}},404===r&&(j(),d||(d='The requested resource for service "'+m.name+'" could not be found:\n\n'+o)),401===r)if(i&&i.success){if(m.invalidateAuthentication(),!i.hasRetried){i.hasRetried=!0;var u=b.Deferred();return k(c,e,b.extend(h,{dfd:u})).done(function(a){p.resolve(a)}).fail(function(a){p.reject(a)})}j()}else i&&m.getPendingAuthenticationRequest()&&!i.hasRetried?(i.hasRetried=!0,m.getPendingAuthenticationRequest().done(function(){var a=b.Deferred();return k(c,e,b.extend(h,{dfd:a})).done(function(a){p.resolve(a)}).fail(function(a){p.reject(a)})}).fail(function(){j()})):j();else"POST"===n?201!==r&&200!==r&&j():-1!==b.inArray(n,["PUT","PATCH","DELETE"])?204!==r&&200!==r&&j():200!==r&&j();d?p.reject(d):p.resolve(a)}).fail(function(a){var b=a.error;if(d(b,"Invalid Request: Unauthorized endpoint")&&window.confirm("To access this Data Source, you will need to add its endpoint as a Remote Site from Salesforce Setup.\n\nWould you like to do that now?")){var c=window.location.href+"",e=j(c.substring(c.indexOf("/",c.indexOf("//")+2),c.length));window.location="/0rp/e?setupid=SecurityRemoteProxy&IsActive=1&retURL="+e+"&cancelURL="+e+"&EndpointUrl="+j(n)+"&SiteName="+m.name.replace(/[\W]+/g,"")+'&DescriptionField=For Skuid Model Service "'+m.name+'"'}p.reject('Request to service "'+m.name+'" failed: '+b)}))}).fail(function(a){p.reject('Unable to authenticate to service "'+m.name+'": '+a)}),p.promise()};return k(c,e,b.extend(h,{dfd:i})),i.promise()},w=function(a,b,c,d){return l(a,b)+"__"+c+(d?"__"+d:"")},x=function(a){var b=c.getDisplayTypeOfEntity(a);return"INTEGER"===b?"DOUBLE":b},y=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},z=function(a){return b.map(a.split("."),function(a){return y(a)}).join(" ")},A=function(a,b){var c,d=x(b),e={id:a,label:z(a),isPolymorphic:!1,isNamePointing:!1,displaytype:d};if("ARRAY"===d){var f=null;b.length&&(f=x(b[0])),e.rel=a,e.ref=a,e.referenceTo=[{objectName:a,displaytype:f,label:a,relationshipName:a}]}else if("OBJECT"===d)e.rel=a,e.ref=a,e.referenceTo=[{objectName:a,label:a,relationshipName:a}];else if("DOUBLE"===d)if(c=""+b,b%1===0)e.precision=c.length,e.scale=0;else{var g=c.split(".");e.precision=g[0].length,e.scale=2===g.length?g[1].length:0}return e},B={},C=function(d,e){e||(e={});var f,g,h,i,j,m=b.Deferred(),n=H(d),o=d.service,p=d.scopes;if(n&&(f=n.endpoint||n.serviceUrl,g=n.verb,h=n.dataType,p=n.scopes,i=n.pathToContent),!f||!g||!o)return m.reject("Cannot retrieve metadata for Model without a valid Service, Service Url, and Request Method.").promise();if(n&&"query"!==n.type){if(d&&d.fields&&d.fields.length){var q={};return b.map(d.fields,function(a){var b,c=a.displaytype;b="BOOLEAN"===c?!0:"DATE"===c||"DATETIME"===c?new Date:"DOUBLE"===c||"NUMBER"===c||"PERCENT"===c?2.2:"INTEGER"===c?2:"PHONE"===c?"(800) 222-3333":"EMAIL"===c?"j@g.co":"ARRAY"===c?[]:"OBJECT"===c?{}:"a",q[a.id]=b}),m.resolve(q).promise()}return m.reject('Unable to retrieve metadata for this Model. If a query method cannot be defined for this Model (i.e. if its purpose is purely for creating/modifying/deleting records, then please click "Add Field" to manually add the fields that you would like to use.').promise()}if(j=w(o.serviceUrl,f,g,i),B[j])return B[j];var r,s,t=a.utils.extractFieldsFromTemplate(f,{ignoreFunctions:!0}),x={},y={},z={},A=function(a,c){var d=a.split("."),e=z;b.each(d,function(a,b){a===d.length-1?e[b]=c:(e[b]||(e[b]={}),e=e[b])})},C=function(a){var c=b.Deferred(),e=v(d,{url:a,verb:g,dataType:h,type:"query",scopes:p},{isSample:!0});return B[j]=m.promise(),e.done(function(a){c.resolve(u(a.body))}).fail(function(a){c.reject(a)}).always(function(){delete B[j]}),c.promise()},D=function(e,g){var h,i,j,k,l,n,o,p,q,s=c.generateUniqueId(),t=[],u={};b.each(e,function(a,b){var c={};c.uiOnly=!0,c.id=b.key,c.label=a,c.displaytype="TEXT",c.createable=c.editable=c.accessible=!0,t.push(c),"undefined"!=typeof b.data&&(u[c.id]=b.data)}),i=new a.model.Model({id:s,accessible:!0,createable:!0,fields:t}),i.initialize().register(),j=i.createRow(),c.size(u)&&i.updateRow(j,u),h=b.map(t,function(b){return new a.ui.Field(j,i,null,{fieldId:b.id,mode:"edit"})}),k=b('<div title="Please provide sample values for Merge Variables needed for this Model Service" class="nx-editor"/>'),l=new a.ui.Editor(k,{showSaveCancel:!1});var v=f;b.each(t,function(a,b){v=v.replace(b.label,"<b>"+b.label+"</b>")}),l.header.append(b('<div class="nx-editor-header-title">').html("<b>Model: </b>"+d.id+"<br/><b>Service URL:</b> "+v).css({color:"black","font-size":"1.2em","font-weight":"400","word-break":"break-all"})),k.append(a.ui.createFieldSet(h,{editor:l})),g&&g.error&&l.handleMessages([{severity:"ERROR",message:g.error}]),n=function(){m.reject("All parameters for Model URL not provided --- unable to retrieve metadata for Model"),k.dialog("destroy").remove(),i.unregister()},o=function(){var a={};b.each(t,function(b,c){var d=c.label,e=c.id,f=i.getFieldValue(j,e,!0);A(d,f),a[d]=f}),r.updateSettings(a),b.blockUI({message:"Retrieving metadata from REST service..."}),b.when(C(c.mergeAsText("global",f,{apiExtensions:z}))).done(function(a){m.resolve(a),b.unblockUI(),n()}).fail(function(a){b.blockUI({message:a,timeout:5e3})})},p=[{text:"Retrieve metadata",icons:{primary:"ui-icon-check"},click:o},{text:"Cancel",icons:{primary:"ui-icon-close"},click:n}],q=function(){b(this).click().find(":input").first().focus()},k.dialog({resizable:!0,modal:!0,width:"50%",open:q,close:function(){n()},buttons:p}),b.unblockUI()};return t&&t.length?(r=k().createModelSettingsService(d.id),s=r.getSettings(),b.each(t,function(a,b){var c,d="var"+a;e.ignoreCache!==!0&&(c=s[b]),y[b]={key:d,data:c},"undefined"!=typeof c?A(b,c):x[b]={key:"var"+a}}),c.size(x)?D(x):C(c.mergeAsText("global",f,{apiExtensions:z})).done(function(a){m.resolve(a)}).fail(function(a){D(y,{error:"Unable to retrieve metadata for Model: "+a+". Please check that sample parameters for the Model URL are valid, and then re-request metadata."})})):C(f).done(function(a){m.resolve(a)}).fail(function(a){m.reject('Error connecting to REST Data Source at URL "'+l(o.serviceUrl,f)+'": '+a)}),m.promise()},D=function(a){var b=a.crumb,c=a.service,d=a.modelXML;if(0===a.index){var e=d.attr("verb");b.rel=b.ref=c.name+(e?": "+e:"")}return b},E=function(a){var c,d=a.entity,f=a.result,g=d.path,i=[],j=[],k={fields:i,childRelationships:j,methods:d.methods,endpoint:d.serviceUrl},l=d.pathToContent;return l&&(f=h(f,l)),g&&(e(g,".")||e(g,":"))&&(g=g.substring(0,g.length-1)),c=g?h(f,g):f,c instanceof Array&&c.length&&(c=c[0]),c&&b.each(Object.keys(c),function(a,b){var d=c[b],e=A(b,d);i.push(e)}),K(k),k},F=function(c){var d=c.model,e=new a.model.Model(d);return c.ignorePathToContent&&delete e.pathToContent,b.extend(e,{path:c.path||""}),e},G=function(){return"Loading sample body for REST service..."},H=function(a){var b,c;return"readwrite"===a.type&&(c=a.methods.filter(function(a){return"query"===a.type}),b=c.length?c[0]:a.methods&&a.methods.length?a.methods[0]:!1),b||(b={endpoint:a.serviceUrl||a.endpoint,verb:a.verb,scopes:a.scopes,pathToContent:a.pathToContent,type:"query"}),b},I=function(a){var b=H(a);return w(a.service.serviceUrl,b.endpoint||b.serviceUrl,b.verb,c.combineStrings(b.pathToContent,a.path,"."))},J=function(a){a||(a={});var c=b.Deferred(),d=a.entities,e=a.service,f=[],g=[],h={};return b.each(d,function(b,c){e&&!c.service&&(c.service=e);var d=C(c,{ignoreCache:a.ignoreCache});d.done(function(a){h[b]=a}),g.push(d)}),b.when.all(g).done(function(){b.each(d,function(a){f.push(h[a])}),c.resolve(f)}).fail(function(a){c.reject(a)}),c.promise()},K=function(a){a.fields||(a.fields=[]);var c=t("query",a)||"GET"===a.verb,d=t("insert",a)||"POST"===a.verb,e=t("update",a)||"PATCH"===a.verb||"PUT"===a.verb,f=t("delete",a)||"DELETE"===a.verb;b.each(a.fields,function(a,b){b.accessible=!0,b.uiOnly||(b.createable&&!d&&(b.createable=!1),b.editable&&!e&&(b.editable=!1)),b.displaytype||(b.displaytype="STRING"),b.filterable!==!1&&(b.filterable=!0)}),a.accessible=!0,a.createable=d,a.updateable=e,a.deleteable=f,a.queryable=a.filterable=c},L=function(a){var c=b.Deferred(),d=[];return b.each(a,function(a,c){var e,f=b.Deferred(),g=H(c);return d.push(f.promise()),g&&"query"===g.type?(e={url:g.endpoint||g.serviceUrl,verb:g.verb,dataType:g.dataType,scopes:g.scopes,type:g.type},void v(c,e).done(function(a){var d,e=u(a.body),g={};e&&c.pathToContent?d=h(e,c.pathToContent):e&&(d=e),d&&(d instanceof Array||(d=[d]),b.each(d,function(a,b){b.Id||(b.Id=p())})),g.lastLoadTime=(new Date).getTime(),g.data=d,g.debug=c.debug,g.soql=c.soql,f.resolve(g)}).fail(function(a){f.reject(a)})):(f.resolve({data:[],lastLoadTime:(new Date).getTime()}),!0)}),b.when.all(d).done(function(a){c.resolve(a)}).fail(function(a){c.reject(a)}),c.promise()},M=function(c){var d=b.Deferred();return b.each(c.operations,function(c,e){var k=a.$M(e.id),l=[],m=s("insert",k),o=s("update",k),q=s("delete",k);b.each(e.changes,function(a,c){var d,e={},g=k.getRowById(a),h=c.__deleted,i=!h&&n(a),p=!i&&!h,r=i?m:p?o:q,s=r.verb,t=r.scopes,u="asjsoninbody",v=r.sendChanges||u,w=r.endpoint;if(i?d={type:"insert",originalRecordId:a,originalRecord:g,request:{url:w,method:s,context:{model:k,row:g},scopes:t},method:r}:p?d={type:"update",originalRecordId:a,originalRecord:g,request:{url:w,method:s,context:{model:k,row:g},scopes:t},method:r}:h&&(d={type:"delete",originalRecordId:a,originalRecord:g,request:{url:w,method:s,context:{model:k,row:g},scopes:t},method:r}),p||i){var x="autoprefix"===r.changeMapping,y=d.request;b.each(c,function(a,b){e[(x?r.changeMappingPrefix:"")+a]=b}),"asjsoninbody"===v?y.data=e:"asformdatainbody"===v?(y.dataType="application/x-www-form-urlencoded",y.data=b.map(e,function(a,b){return j(b)+"="+j(a)}).join("&")):"inheaderperfield"===v?y.headers=e:"inqueryparamperfield"===v&&(y.url+=f(y.url,"?")?"&":"?",y.url+=b.map(e,function(a,b){return j(b)+"="+j(a)}).join("&"))}l.push(d)});var r,t=[],w=[],x=[],y=[],z=[],A=function(a){var c=a.request,d=c.type,f=c.method,j=a.response,k=j?j.body:null,l=j?j.headers:null,m=a.error,n=[],o=[],q={errors:n,messages:o,source:e.id},s=a.isSuccess,t=f.successIf,v=f.successField,z=f.successValue;if(k&&g(k)&&(k=u(k)),s&&("responsefieldispresent"===t?s=i(k,v):"responsefieldistrue"===t?s=h(k,v,!0)===!0:"responsefieldequals"===t?s=h(k,v,!0)===z:"responseheaderispresent"===t?s=i(l,v,!0):"responseheaderequals"===t?s=h(l,v)===z:"responsebodyequals"===t&&(s=k===z)),q.success=s,s||(r=!0,n.push({message:m,severity:"ERROR"})),"insert"===d){if(q.oldId=c.originalRecordId,s){var A=f.insertResponse||"recordinbody",B=f.createdRecordIdLocation,C={};b.extend(C,c.originalRecord),"recordinbody"===A?(k.hasOwnProperty("Id")?q.id=k.Id:q.id=p(),b.extend(C,k)):"idinbodyfield"===A?q.id=h(k,B):"idinheader"===A?q.id=h(l,B):"none"===A&&(q.id=p()),q.record=C,q.record.Id=q.id}x.push(q)}else"update"===d?(q.id=c.originalRecordId,y.push(q)):"delete"===d&&(q.id=c.originalRecordId,w.push(q))};b.each(l,function(a,c){var d=v(k,c.request);b.when(d).done(function(a){A({request:c,response:a,isSuccess:!0})}).fail(function(a){A({request:c,error:a,isSuccess:!1})}),t.push(d)}),b.when.all(t).always(function(){d.resolve({deleteResults:w,globalErrors:z,insertResults:x,totalsuccess:!r,updateResults:y})})}),d.promise()},N=function(a){a.sourceType="param",a.operator="=",a.encloseValueInQuotes=!0},O=function(f){f||(f={});var g,h=f.component,i=h.state,j=f.propertiesViewer,l=f.onChange||function(){h.rebuildProps(j)},m=[],n=[{name:"Method",props:m}],o=i.closest("model"),p=o.attr("service"),q=o.attr("id"),r=-1!==b.inArray(f.type,["update","insert"]),s=i.attr("sendchanges"),t=i.attr("successif");if(m.push({id:"endpoint",type:"template",location:"attribute",displayAs:"textarea",modelName:q,label:"Service URL",helptext:"For Data Sources that offer multiple Services, this would be the relative URL to the specific Service to be invoked, e.g. /products/list"}),g=p?a.service.getService(p):null,g&&g.authentication&&"oauth"===g.authentication.method&&m.push({id:"scopes",type:"string",label:"OAuth Scopes Needed",helptext:'Skuid will connect to this Data Source via OAuth. If the specific Service URL you are connecting to requires additional OAuth Scopes, enter them here, comma-separated, e.g. "profile,email" or "https://www.googleapis.com/auth/calendar".'}),m.push(k().getServiceAccessMethodProperty({onChange:l,type:f.type})),r){if(m.push({id:"sendchanges",label:"Send "+("update"===f.type?"updated":"new")+" field values...",type:"picklist",defaultValue:"asjsoninbody",picklistEntries:[{value:"asjsoninbody",label:"As JSON in request body"},{value:"asformdatainbody",label:"As URL-Encoded Form data in request body"},{value:"inheaderperfield",label:"In request headers - one per changed field"},{value:"inqueryparamperfield",label:"In URL parameters - one per changed field"}],onChange:l}),e(s,"perfield")){var u="inheaderperfield"===s?"header":"parameter";m.push({id:"changemapping",label:"Field name to "+u+" name mapping",type:"picklist",defaultValue:"auto",picklistEntries:[{value:"auto",label:"Same names"},{value:"autoprefix",label:"Same names, with added prefix"}],onChange:l}),"autoprefix"===i.attr("changemapping")&&m.push({id:"changemappingprefix",type:"string",label:c.capitalizeFirst(u)+" name prefix"})}m.push({id:"successif",label:"Method succeeds if...",type:"picklist",defaultValue:"requestsucceeds",picklistEntries:[{value:"requestsucceeds",label:"Request succeeds"},{value:"responsefieldispresent",label:'"Success" Field in response body is present'},{value:"responsefieldistrue",label:'"Success" Field in response body is true'},{value:"responsefieldequals",label:'"Success" Field in response body equals a value'},{value:"responsebodyequals",label:"Response body equals a value"},{value:"responseheaderispresent",label:'"Success" Header is present in response'},{value:"responseheaderequals",label:'"Success" Header in response equals a value'}],onChange:l}),d(t,"responsefield")?m.push({id:"successfield",type:"string",label:"Success Field Name"}):d(t,"responseheader")?m.push({id:"successfield",type:"string",label:"Success Header Name",helptext:"The name of a Header in the response which, if present, indicates that this request succeeded, e.g. X-Record-Created"}):e(t,"equals")&&m.push({id:"successvalue",type:"string",label:"Contents of response body if request succeeds"}),"insert"===f.type&&(m.push({id:"insertresponse",label:"Response handling",type:"picklist",defaultValue:"recordinbody",picklistEntries:[{value:"recordinbody",label:"Created record will be returned in response body"},{value:"idinbodyfield",label:"Id of created record will be returned in field in response body"},{value:"idinheader",label:"Id of created record will be returned in response header"},{value:"none",label:"No information about created record will be returned"}],onChange:l}),"idinbodyfield"===i.attr("insertresponse")?m.push({id:"createdrecordidlocation",type:"string",label:"Name of Field containing created record's Id",helptext:"What is the name of / path to the Field in the expected response that will contain the created record's id? e.g. id, recordId"}):"idinheader"===i.attr("insertresponse")&&m.push({id:"createdrecordidlocation",type:"string",label:"Name of Header containing created record's Id",helptext:"What is the name of the Header expected in the response that will contain the created record's id? e.g. X-Record-Id, X-New-Record-Id"}))}else"query"===f.type&&m.push(k().getPathToContentProperty({component:h}));return n},P={runtime:{metadataSource:"local"},composer:{modelConditionLabel:"URL Merge Condition",modelConditionsLabel:"URL Merge Conditions",canFieldsBeSelected:function(a){var b,c=a.model,d="readwrite"===c.attr("type"),e=c.attr("service")&&(d?c.children("methods").children("method[verb][verb!=''][endpoint][endpoint!='']").length:c.attr("verb")&&c.attr("endpoint")),f="select a valid Service endpoint URL and access method";return"components"===a.mode?(b=c.children("fields").children().length,e||b?!0:"Please either "+f+", or manually add and define expected fields to this Model."):e?!0:"Please "+f+"."}},canAutoGenerateConditionsFromFields:!1,validConditionTypes:["fieldvalue","param","userinfo","blank","modelmerge"],canConditionsBeGrouped:!1,canFieldsBeIndividuallySearched:!1};new a.adapter.Adapter({buildEntityMetadataRequest:F,getEntityMetadata:J,getEntityMetadataCacheKey:I,getEntityMetadataLoadingMessageFromBreadcrumb:G,getMethodProperties:O,getNameField:q,getNewId:o,initialize:K,isNewId:n,load:L,makeRequest:v,name:"REST",populateBreadcrumbFromEntityMetadata:D,processEntityMetadataRequest:E,properties:P,save:M,setDefaultConditionState:N})}(skuid);